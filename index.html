<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اِسْتَمِعْ إِلى الصَّوْت</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@700&family=Noto+Naskh+Arabic:wght@700&display=swap');

        :root {
            --player1-bg: #4a90e2;
            --player2-bg: #e24a4a;
            --correct-color: #50e3c2;
            --incorrect-color: #d0021b;
            --neutral-bg: #f4f4f4;
            --dark-text: #333;
            --selected-color: #888;
            --bonus-yellow: #ffde59;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        html { overflow: hidden; }
        body {
            font-family: 'Cairo', sans-serif;
            display: flex; justify-content: center; align-items: center;
            height: 100dvh; background-color: var(--neutral-bg); overflow: hidden; direction: ltr;
        }
        #loading-indicator {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; color: var(--dark-text); 
            z-index: 200; opacity: 1; transition: opacity 0.5s ease-out;
            padding: 20px; text-align: center; 
        }
        #loading-indicator.initial-hide {
            opacity: 0;
            pointer-events: none;
        }
        #loading-indicator.hidden { opacity: 0; pointer-events: none; }

        #game-container { display: flex; width: 100%; height: 100%; position: relative; }
       #progress-bar { 
            position: absolute; 
            top: 15px; 
            left: 0; 
            width: 100%; 
            display: flex; 
            gap: 30px; /* Kutucuklar arası boşluk */
            justify-content: center; 
            align-items: center; 
            height: 30px; 
            z-index: 51;
            padding: 0 30px; /* DEĞİŞTİ: Sağ ve soldan 30px boşluk bırakıldı */
        }
        .progress-dot { 
            flex: 1; 
            height: 100%; 
            background-color: #ccc; 
            border-radius: 5px; /* DEĞİŞTİ: Ayrık oldukları için köşeler hafif yuvarlatıldı */
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            position: relative; 
            /* border-left satırı silindi, artık gerek yok */
        }
        .progress-dot:first-child { border-left: none; }
        .progress-dot.correct { 
            background-color: var(--correct-color);
            transform: scale(1.15); /* BURASI DEĞİŞTİ: 1.35 yerine 1.15 yapıldı (Daha az büyüme) */
            z-index: 20; 
            box-shadow: 0 0 15px var(--correct-color); 
            border: 2px solid white; 
            border-radius: 4px; 
        }
      .progress-dot.incorrect { 
            background-color: var(--incorrect-color);
            transform: scale(1.15); /* BURASI DEĞİŞTİ: 1.35 yerine 1.15 yapıldı (Daha az büyüme) */
            z-index: 20; 
            box-shadow: 0 0 15px var(--incorrect-color); 
            border: 2px solid white; 
            border-radius: 4px;
        }
        
        #game-header {
            position: absolute; 
            top: 60px; /* DEĞİŞTİ: 30px'ten 60px'e çekildi (Çubuğun altında kalmasın diye) */
            left: 0; 
            width: 100%; 
            padding: 15px; 
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            text-align: center; 
            z-index: 50; 
            direction: rtl;
            opacity: 0; 
            transform: translateY(-30px); 
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        #game-header.visible { opacity: 1; transform: translateY(0); }
        #game-header h1 { font-family: 'Noto Naskh Arabic', serif; font-size: 2.8rem; margin: 0; color: var(--dark-text); }

      .player-section {
    flex: 1;
    /* Üst ve alt boşlukları azalttık ki ortalamaya yer kalsın */
    padding: 60px 10px; 
    display: flex;
    flex-direction: column;
    /* İçeriği dikey eksende merkeze çeker */
    justify-content: center; 
    align-items: center;
    height: 100%;
    overflow-y: hidden;
    position: relative;
}
        #player1-section { background-color: rgba(74, 144, 226, 0.1); }
        
        #center-controls {
            position: absolute; 
            bottom: 20px; 
            right: 20px; 
            left: auto; 
            transform: none; 
            display: flex; 
            flex-direction: row; 
            align-items: center; 
            gap: 10px; 
            z-index: 10;
            opacity: 0; transition: opacity 0.6s ease, transform 0.6s ease;
        }
        #center-controls.visible { opacity: 1; transform: none; }
        #round-timer-bar-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 12px; background-color: #ccc; z-index: 51; display: none; }
        #round-timer-bar { width: 100%; height: 100%; background-color: var(--incorrect-color); transform: scaleX(1); transform-origin: left; }
        @keyframes deplete-linear { 0% { transform: scaleX(1); } 100% { transform: scaleX(0); } }

        #audio-button {
            position: relative; width: 80px; height: 80px; border-radius: 50%; background-color: white; cursor: pointer;
            display: flex; justify-content: center; align-items: center; transition: all 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 5px solid #ccc; z-index: 12;
        }
        #audio-button .icon { width: 35px; height: 35px; fill: #333; z-index: 13; }
        #audio-button .icon.stop-icon { display: none; }
        #audio-button.waiting .play-icon { animation: pulse-wait 1.5s infinite ease-in-out; }
        @keyframes pulse-wait { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        #audio-button:disabled { cursor: not-allowed; opacity: 0.5; }

        #audio-button::before,
        #audio-button::after {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            border-radius: 50%;
            background-color: transparent;
            border: 4px solid var(--player1-bg);
            opacity: 0;
            transform: scale(1);
            z-index: 11; 
        }
        #audio-button.playing-sound::before {
            animation: wave-pulse 1.5s ease-out infinite;
        }
        #audio-button.playing-sound::after {
            animation: wave-pulse 1.5s ease-out 0.5s infinite;
        }
        @keyframes wave-pulse {
            0% { transform: scale(1); opacity: 0.6; }
            100% { transform: scale(1.4); opacity: 0; }
        }


        #next-round-button {
            margin-top: 0; 
            width: 80px;
            height: 80px;
            border-radius: 50%;
            padding: 0;
            cursor: pointer; 
            border: 5px solid #ccc; 
            background-color: white; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            transition: all 0.2s; 
            z-index: 11; 
            display: flex; 
            justify-content: center;
            align-items: center;
        }
        #next-round-button:hover { transform: scale(1.05); }

        #next-round-button .icon {
            width: 35px; 
            height: 35px; 
            fill: #333; 
            z-index: 13;
        }

        #next-round-button:disabled { 
            cursor: not-allowed; 
            opacity: 0.5; 
        }
        
       .image-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* Masaüstünde 4 sütun */
            gap: 20px; /* Görseller arası boşluk biraz artırıldı */
            width: 95%; /* Genişlik ekranın %95'ini kaplasın */
            max-width: 1300px; /* DEĞİŞTİ: 1000px'den 1300px'e çıkarıldı (Daha büyük görsel) */
            margin: auto;
            border: 5px solid transparent;
            border-radius: 20px;
            padding: 10px;
            transition: all 0.6s ease;
        }
        .image-grid.highlight { border-color: var(--player1-bg); box-shadow: 0 0 20px var(--player1-bg); }
        .image-grid.locked .image-container { pointer-events: none; opacity: 0.7; }

       .image-container {
            width: 100%; 
            padding-top: 100%; 
            position: relative; 
            border: 5px solid transparent; 
            border-radius: 15px; 
            overflow: hidden;
            background-color: #e0e0e0; 
            /* Geçişleri yumuşatır */
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s, border-color 0.2s; 
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* Hafif gölge */
        }

        /* --- YENİ EKLENEN KISIM: HOVER EFEKTİ --- */
        /* Sadece oyun kilitli değilken (cevap verilmemişken) çalışır */
        .image-grid:not(.locked) .image-container:hover {
            transform: translateY(-5px) scale(1.03); /* Yukarı kalkma ve büyüme */
            box-shadow: 0 15px 25px rgba(0,0,0,0.2); /* Gölge derinleşir (havada duruyor hissi) */
            border-color: #bbb; /* Çerçeve hafif grileşir */
            z-index: 10;
        }

        /* Tıklama anı (Basılma hissi) */
        .image-grid:not(.locked) .image-container:active {
            transform: translateY(0) scale(0.95); /* Aşağı inme ve küçülme */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Gölge azalır */
        }
        .image-grid.locked .image-container.selected { border-color: var(--selected-color); opacity: 1; transform: scale(0.95); }
        .image-container img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .image-container.correct { border-color: var(--correct-color); opacity: 1; }
        .image-container.incorrect { border-color: var(--incorrect-color); opacity: 1; }

        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; direction: rtl;
            opacity: 0; pointer-events: none; transition: opacity 0.8s ease, background-color 0.8s ease;
        }
        #overlay.visible { opacity: 1; pointer-events: auto; }
        #overlay.transparent-bg { background-color: transparent; }
        
        #start-button {
            display: none;
        }

        .overlay-button {
            padding: 20px 40px; font-family: 'Noto Naskh Arabic', serif; font-size: 2.5rem; cursor: pointer; border: none; border-radius: 10px;
            background-color: var(--player1-bg); color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #reset-icon { font-size: 5rem; cursor: pointer; display: none; }
        #countdown { font-size: 12rem; font-weight: bold; color: var(--dark-text); animation: zoom-fade 1s ease-in-out infinite; }

        #winner-display {
            font-family: 'Noto Naskh Arabic', serif; 
            font-size: 3.0rem; font-weight: bold; color: var(--dark-text);
            margin-bottom: 20px; display: none; text-align: center; animation: zoom-fade 1.5s ease-in-out infinite;
        }

        #player-select-prompt { display: none; flex-direction: column; align-items: center; text-align: center; }
        #player-select-text { font-family: 'Noto Naskh Arabic', serif; font-size: 3.5rem; font-weight: bold; color: var(--dark-text); margin-bottom: 20px; }
        #start-countdown-button { font-size: 6rem; cursor: pointer; background: none; border: none; padding: 10px; color: var(--dark-text); transition: transform 0.2s ease-out; animation: zoom-fade 1.5s ease-in-out infinite; }
        #start-countdown-button:hover { transform: scale(1.1); }

        @keyframes zoom-fade { 0% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1); opacity: 1; } 100% { transform: scale(0.8); opacity: 0.5; } }

        @media (max-width: 768px) {
            #progress-bar { height: 20px; top: 10px; } /* Mobilde biraz daha az boşluk */
            #game-header { top: 45px; } /* Başlık buna göre ayarlandı */
            #center-controls { bottom: 20px; right: 20px; }
            #audio-button { width: 70px; height: 70px; }
            #next-round-button { width: 70px; height: 70px; }
            .player-section { padding: 140px 5px 110px 5px; } 
            .image-grid { gap: 5px; max-width: 100%; }
            #game-header h1 { font-size: 2.0rem; } 
            .progress-dot { border-radius: 0; }
            #winner-display { font-size: 2.2rem; }
            #player-select-text { font-size: 2.5rem; }
            #start-countdown-button { font-size: 5rem; }
        }

        @media (max-width: 480px) {
            #progress-bar { height: 15px; top: 10px; }
            #game-header { top: 40px; } /* Mobilde başlık konumu */
            .player-section { padding: 130px 5px 100px 5px; } 
            #center-controls { bottom: 10px; right: 10px; gap: 5px;}
            #audio-button { width: 60px; height: 60px; }
            #audio-button .icon { width: 30px; height: 30px; }
            #next-round-button { width: 60px; height: 60px; }
            #next-round-button .icon { width: 30px; height: 30px; }
            #game-header h1 { font-size: 1.8rem; } 
            .progress-dot { border-radius: 0; }
        }
/* Kırmızı Dalga Animasyonu */
@keyframes red-wave-animation {
    0% {
        transform: scale(1);
        opacity: 0.8;
        border-color: rgba(255, 0, 0, 0.8);
    }
    100% {
        transform: scale(1.6);
        opacity: 0;
        border-color: rgba(255, 0, 0, 0);
    }
}

/* JavaScript ile bu sınıf eklendiğinde animasyon çalışacak */
#next-round-button.pulse-active::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    border-radius: 50%;
    border: 4px solid red; /* Kırmızı halka */
    z-index: -1; /* Butonun arkasında dursun */
    animation: red-wave-animation 1.5s infinite ease-out;
}

/* Butonun z-index ayarı ve taşmayı göstermesi için */
#next-round-button {
    overflow: visible; /* Dalganın buton dışına taşmasına izin ver */
    /* Mevcut kodunda position relative yoksa ekle (var görünüyor ama garanti olsun) */
    position: relative; 
}
/* --- YENİ EKLENEN KISIM: İSTENEN MOBİL DÜZENLEMELER --- */

/* Mobil Dikey (Telefonlar) - Maksimum 480px Genişlik */
@media (max-width: 480px) and (orientation: portrait) {
    /* 2 Satır x 2 Sütun Görsel Izgara */
    .image-grid {
        grid-template-columns: repeat(2, 1fr); 
        gap: 15px;
        max-width: 90%; 
    }
}

/* Mobil Yatay (Tabletler, Büyük Telefonlar) - 481px'ten 768px'e kadar genişlik ve Yatay Yönelim */
/* NOT: Eğer 480px'ten küçük cihazlar da yatay kullanılırsa bu kısım çalışmayacaktır. */
/* Eğer tüm mobil yatay istenirse, sadece (orientation: landscape) kullanılabilir. */
@media (max-width: 768px) and (orientation: landscape) {
    
    /* İlerleme Çubuğu Daha İnce */
    #progress-bar { 
        height: 15px; /* Varsayılan 30px veya mobilde 20px'ti. Daha da ince yapıldı. */
        top: 8px; /* Konum ayarı */
        gap: 15px;
    }
    
    /* Yönerge (Başlık) Daha Küçük */
    #game-header {
        top: 35px; /* İnce çubuğa göre konum ayarlandı */
        padding: 8px 15px; /* Daha az padding */
    }
    #game-header h1 { 
        font-size: 1.5rem; /* Varsayılan 2.8rem veya mobilde 2.0rem'di. Daha da küçük yapıldı. */
    }

    /* Görsel Alanının Dikeyde Daha Fazla Yer Kaplaması İçin Padding Azaltıldı */
    .player-section { 
        padding: 100px 5px 60px 5px; /* Üst/Alt boşluk azaltıldı */
    }

    /* Izgarayı biraz küçültelim */
    .image-grid {
        gap: 10px;
        max-width: 1000px; /* Varsayılan 1300px'ti. Biraz küçültüldü. */
    }
}

/* Mobil Dikey (Tabletler) - 481px'ten 768px'e kadar genişlik ve Dikey Yönelim */
@media (min-width: 481px) and (max-width: 768px) and (orientation: portrait) {
    /* 2 Satır x 2 Sütun Görsel Izgara */
    .image-grid {
        grid-template-columns: repeat(2, 1fr); 
        gap: 20px;
        max-width: 80%; /* Daha büyük ekranda biraz daha daraltıldı */
    }
}
    </style>
</head>
<body>
    <div id="loading-indicator" class="initial-hide">...يتم التحميل</div>

    <div id="game-container">
        
        <div id="progress-bar">
            <div class="progress-dot"></div>
            <div class="progress-dot"></div>
            <div class="progress-dot"></div>
            <div class="progress-dot"></div>
            <div class="progress-dot"></div>
            <div class="progress-dot"></div>
            <div class="progress-dot"></div>
        </div>

        <div id="game-header">
            <h1>اِسْتَمِعْ إِلى الصَّوْت، وَاخْتَر الصّورَة المُناسِبَة</h1>
        </div>

        <div class="player-section" id="player1-section">
            <div class="image-grid" id="image-grid-1">
                <div class="image-container"></div>
                <div class="image-container"></div>
                <div class="image-container"></div>
                <div class="image-container"></div>
            </div>
        </div>

        <div id="center-controls">
            <button id="audio-button" disabled>
                <svg class="icon play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                <svg class="icon stop-icon" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"></path></svg>
            </button>

            <button id="next-round-button" disabled>
                <svg class="icon" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"></path></svg>
            </button>
        </div>

        <div id="round-timer-bar-container">
            <div id="round-timer-bar"></div>
        </div>

        <div id="overlay">
            <div id="countdown" style="display: none;"></div>
            <div id="winner-display"></div>

            <div id="player-select-prompt">
                <div id="player-select-text">هَلْ أَنْتَ مُسْتَعِدّ؟</div>
                <button id="start-countdown-button">▶️</button>
            </div>
            <button class="overlay-button" id="start-button">اِبْدَأْ</button>
            <div id="reset-icon">&#128260;</div>
        </div>
    </div>

    <script>
        // DOM Elementlerini seçme
        const loadingIndicator = document.getElementById('loading-indicator');
        const startButton = document.getElementById('start-button');
        const overlay = document.getElementById('overlay');
        const countdownDisplay = document.getElementById('countdown');
        const resetButton = document.getElementById('reset-icon');
        const audioButton = document.getElementById('audio-button');
        const playIcon = audioButton.querySelector('.play-icon');
        const stopIcon = audioButton.querySelector('.stop-icon');
        const nextRoundButton = document.getElementById('next-round-button');
        const roundTimerBarContainer = document.getElementById('round-timer-bar-container');
        const roundTimerBar = document.getElementById('round-timer-bar');
        const gameHeader = document.getElementById('game-header');
        const centerControls = document.getElementById('center-controls');
        const allGrids = document.getElementById('image-grid-1'); 
        const grid1 = document.getElementById('image-grid-1');
        const allImageContainers = document.querySelectorAll('#image-grid-1 .image-container');
        const gameContainer = document.getElementById('game-container');
        const winnerDisplay = document.getElementById('winner-display');
        const playerSelectPrompt = document.getElementById('player-select-prompt');
        const startCountdownButton = document.getElementById('start-countdown-button');

        // Audio Ayarları
        // >>> DEĞİŞİKLİK: Efektler için Web Audio, oyun sesleri için HTML5 Audio <<<
        const audioContext = new (window.AudioContext || window.webkitAudioContext)(); // Efektler için (createTone)
        const audioBuffers = {}; // Sadece 'createTone' seslerini tutacak
        let currentAudio = new Audio(); // HTML5 Audio, oyun sesleri (s1.mp3 vb) için
        
        const gameData = [
            { id: 1, image: "1.jpeg", audio: "s1.mp3" },
            { id: 2, image: "2.jpeg", audio: "s2.mp3" },
            { id: 3, image: "3.jpeg", audio: "s3.mp3" },
            { id: 4, image: "4.jpeg", audio: "s4.mp3" },
            { id: 5, image: "5.jpeg", audio: "s5.mp3" },
            { id: 6, image: "6.jpeg", audio: "s6.mp3" },
            { id: 7, image: "7.jpeg", audio: "s7.mp3" },
            { id: 8, image: "8.jpeg", audio: "s8.mp3" }
        ];

        // Oyun Durumu (State)
        let state = {
            currentRound: 0,
            totalRounds: 8, 
            questions: [],
            isAnswered: false,
            answers: { player1: null },
            answerTimestamps: { player1: null },
            roundTimer: null,
            audioInterval: null,
            isMatchOver: false,
            roundTimerStartTime: null,
            roundTimerRemaining: 0
        };

        // --- ÖN YÜKLEME FONKSİYONLARI ---

        // >>> DEĞİŞİKLİK: loadGameAudio (HTML5 Audio kullanır) <<<
        // 'file://' protokolünde çalışır.
        function loadGameAudio() {
            return new Promise((resolve, reject) => {
                let loadedCount = 0;
                const totalAudio = gameData.length;
                if (totalAudio === 0) return resolve();
                
                const onAudioLoad = () => { 
                    loadedCount++; 
                    if (loadedCount === totalAudio) {
                        console.log("Tüm .mp3 oyun sesleri (HTML5) yüklendi.");
                        resolve(); 
                    }
                };

                console.log(".mp3 oyun sesleri (HTML5) yükleniyor...");
                gameData.forEach(item => {
                    const audio = new Audio();
                    audio.src = item.audio;
                    // 'canplaythrough' olayı, sesin internetten tamamen yüklendiğini garanti eder
                    audio.addEventListener('canplaythrough', onAudioLoad, { once: true });
                    // 'error' olayı, dosya bulunamazsa (404) veya yüklenemezse tetiklenir
                    audio.addEventListener('error', (e) => {
                        console.error(`HTML5 ses yüklenemedi: ${item.audio}`, e);
                        reject(new Error(`HTML5 Ses dosyası bulunamadı: ${item.audio}`));
                    }, { once: true }); 
                });
            });
        }

        // preloadImages (Değişiklik yok, 'file://' protokolünde çalışır)
        function preloadImages() {
            return new Promise((resolve, reject) => { 
                let loadedCount = 0;
                const totalImages = gameData.length;
                if (totalImages === 0) { resolve(); return; }
                
                gameData.forEach(item => {
                    const img = new Image();
                    img.src = item.image;
                    img.onload = () => { 
                        loadedCount++; 
                        if (loadedCount === totalImages) {
                            console.log("Tüm resimler yüklendi.");
                            resolve(); 
                        }
                    };
                    img.onerror = () => {
                        console.error(`Resim yüklenemedi: ${item.image}`);
                        reject(new Error(`Resim dosyası bulunamadı: ${item.image}`));
                    };
                });
            });
        }

        // playSound (Değişiklik yok, 'file://' protokolünde çalışır)
        // Sadece 'createTone' ile üretilen efekt sesleri (click, correct) için kullanılır.
        function playSound(key, onEndedCallback = null) {
            if (audioContext.state === 'suspended') {
                audioContext.resume(); 
            }
            if (!audioBuffers[key]) {
                console.warn(`Ses buffer'ı bulunamadı: ${key}`);
                if (onEndedCallback) onEndedCallback();
                return null;
            }
            
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffers[key];
            source.connect(audioContext.destination);
            if (onEndedCallback) { source.onended = onEndedCallback; }
            source.start(0);
            return source;
        }
        
        // createTone (Değişiklik yok, 'file://' protokolünde çalışır)
        function createTone(key, frequency, duration, type = 'sine') {
            return new Promise(async (resolve) => {
                if (audioContext.state === 'suspended') {
                    try { await audioContext.resume(); } 
                    catch (e) { console.warn(`AudioContext ${key} için devam ettirilemedi:`, e); resolve(); return; }
                }
                const sampleRate = audioContext.sampleRate;
                const frameCount = Math.floor(sampleRate * duration);
                const buffer = audioContext.createBuffer(1, frameCount, sampleRate);
                const data = buffer.getChannelData(0); 
                let angle = 0;
                const angleIncrement = (2 * Math.PI * frequency) / sampleRate;
                for (let i = 0; i < frameCount; i++) {
                    let sample;
                    if (type === 'square') { sample = Math.sin(angle) >= 0 ? 0.3 : -0.3; }
                    else if (type === 'sawtooth') { sample = (((angle / Math.PI) - 1) / 2) * 0.3; if (angle > Math.PI) angle -= 2 * Math.PI; }
                    else { sample = Math.sin(angle) * 0.5; }
                    angle += angleIncrement;
                    if (angle > 2 * Math.PI) angle -= 2 * Math.PI;
                    const envelope = Math.pow(1.0 - (i / frameCount), 4); 
                    data[i] = sample * envelope; 
                }
                audioBuffers[key] = buffer;
                resolve();
            });
        }

        // --- OYUN AKIŞI FONKSİYONLARI ---

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startGame() {
            playerSelectPrompt.style.display = 'none';
            startMatch();
            toggleAudio();
        }

        // loadAllAssetsAndStart (Değişiklik yok, mantık aynı)
        // HEM resimleri HEM sesleri (HTML5 Audio ile) yükler.
        async function loadAllAssetsAndStart() {
            if (audioContext.state === 'suspended') {
                await audioContext.resume(); 
            }
            
            startButton.style.display = 'none';
            loadingIndicator.classList.remove('hidden', 'initial-hide'); 
            loadingIndicator.textContent = "...يتم التحميل..."; 
            overlay.classList.remove('transparent-bg'); 

            try {
                console.log("Tüm varlıklar (resim + ses) yükleniyor...");
                
                // 1. Resimler
                const imagePromise = preloadImages();

                // 2. Efekt Sesleri (Web Audio)
                const tonePromise = Promise.all([
                    createTone('correct', 880, 0.3, 'sine'),
                    createTone('incorrect', 220, 0.5, 'sine'),
                    createTone('click', 1500, 0.05, 'sine')
                ]);
                
                // 3. Oyun Sesleri (HTML5 Audio)
                const gameAudioPromise = loadGameAudio(); 

                // 4. HEPSİNİN bitmesini bekle
                await Promise.all([imagePromise, tonePromise, gameAudioPromise]);
                console.log("Tüm görseller ve sesler yüklendi.");

            } catch (e) {
                console.error("Varlıklar yüklenirken hata oluştu:", e);
                loadingIndicator.textContent = `HATA: ${e.message}. Dosya adlarını (1.png, s1.mp3 vb) kontrol edin.`;
                return; 
            }

            loadingIndicator.classList.add('hidden');
            
            if (countdownDisplay) countdownDisplay.style.display = 'none';
            if (playerSelectPrompt) playerSelectPrompt.style.display = 'flex';
            
            gameHeader.classList.add('visible');
            allGrids.classList.add('highlight');
            centerControls.classList.add('visible');
            setTimeout(() => { allGrids.classList.remove('highlight'); }, 600);
        }


        function startCountdownAndGame() {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            playerSelectPrompt.style.display = 'none';
            overlay.classList.remove('visible'); overlay.classList.remove('transparent-bg');
            startGame();
        }

        function startMatch() {
            state.currentRound = 0;
            state.isMatchOver = false;

            // --- DEĞİŞİKLİK BURADA BAŞLIYOR ---
            // 1. ID'si 1 olanı soru listesinden filtreleyerek çıkarıyoruz.
            const questionPool = gameData.filter(item => item.id !== 1);

            // 2. Soru sayısı 8'den 7'ye düştüğü için tur sayısını güncelliyoruz.
            state.totalRounds = questionPool.length;

            // 3. Soruları karıştırıp hazırlıyoruz
            state.questions = shuffleArray([...questionPool]).map(item => ({ ...item, duration: 30000 }));
            // --- DEĞİŞİKLİK BURADA BİTİYOR ---

            nextRound();
        }

        function nextRound() {
            if (state.isMatchOver || state.currentRound >= state.totalRounds) {
                if (!overlay.classList.contains('visible') && !state.isMatchOver) endMatch();
                return;
            }
            resetRound();

            const currentQuestion = state.questions[state.currentRound];
            const correctId = currentQuestion.id;
            const conflictGroupA = [1]; const conflictGroupB = [2, 3, 4];
            let bannedDistractorIds = []; 
            if (conflictGroupA.includes(correctId)) { bannedDistractorIds = conflictGroupB; }
            else if (conflictGroupB.includes(correctId)) { bannedDistractorIds = conflictGroupA; }
            const possibleDistractors = gameData.filter(item => {
                if (item.id === correctId) return false;
                if (bannedDistractorIds.includes(item.id)) return false;
                return true;
            });
            const shuffledDistractors = shuffleArray(possibleDistractors);
            const finalDistractors = shuffledDistractors.slice(0, 3);
            const options = shuffleArray([currentQuestion, ...finalDistractors]);

            allImageContainers.forEach((c, i) => {
                c.dataset.id = options[i].id;
                const img = document.createElement('img');
                img.src = options[i].image; img.alt = "خيار";
                c.appendChild(img);
            });
            
            audioButton.disabled = false;
            state.currentRound++;
        }

        function resetRound() {
            state.isAnswered = false;
            nextRoundButton.classList.remove('pulse-active');
            state.answers = { player1: null };
            state.answerTimestamps = { player1: null };
            state.roundTimerStartTime = null;
            state.roundTimerRemaining = 0;
            clearTimeout(state.roundTimer);
            stopAudioLoop(); 
            nextRoundButton.disabled = true;
            audioButton.classList.remove('round-active');
            roundTimerBarContainer.style.display = 'none';
            roundTimerBar.classList.remove('active');
            roundTimerBar.style.animation = 'none';
            roundTimerBar.style.animationPlayState = 'running';
            void roundTimerBar.offsetWidth;
            roundTimerBar.style.animation = null;
            grid1.classList.remove('locked');
            allImageContainers.forEach(container => {
                container.classList.remove('correct', 'incorrect', 'locked', 'selected');
                const img = container.querySelector('img');
                if (img) img.remove();
            });
        }

        // --- SES KONTROL FONKSİYONLARI ---

        function toggleAudio() {
            if (state.isMatchOver || state.isAnswered || state.currentRound > state.totalRounds || !state.questions[state.currentRound - 1]) return;

            if (!audioButton.classList.contains('round-active')) {
                nextRoundButton.disabled = true;
                audioButton.classList.add('round-active', 'playing-sound', 'waiting');
                const currentDuration = state.questions[state.currentRound - 1].duration;
                state.roundTimerStartTime = Date.now();
                state.roundTimerRemaining = currentDuration;
                roundTimerBarContainer.style.display = 'block';
                roundTimerBar.style.animation = `deplete-linear ${currentDuration / 1000}s linear forwards`;
                roundTimerBar.classList.add('active');
                state.roundTimer = setTimeout(handleTimeout, state.roundTimerRemaining);

                setTimeout(() => {
                    if (state.isMatchOver || !audioButton.classList.contains('round-active') || state.isAnswered) return;
                    audioButton.classList.remove('waiting');
                    startAudioLoop(true); 
                }, 2000);
            } else {
                if (audioButton.classList.contains('playing-sound')) { stopAudioLoop(); } 
                else { startAudioLoop(false); }
            }
        }

        // >>> DEĞİŞİKLİK: startAudioLoop (HTML5 Audio kullanır) <<<
        function startAudioLoop(isInitialCall) {
            if (state.isMatchOver || state.isAnswered || !audioButton.classList.contains('round-active') || state.currentRound > state.totalRounds || !state.questions[state.currentRound - 1]) return;

            if (!isInitialCall) {
                state.roundTimerStartTime = Date.now();
                state.roundTimer = setTimeout(handleTimeout, state.roundTimerRemaining);
                roundTimerBar.style.animationPlayState = 'running';
            }
            audioButton.classList.add('playing-sound');
            playIcon.style.display = 'none';
            stopIcon.style.display = 'block';
            
            const audioSrc = state.questions[state.currentRound - 1].audio; // örn: "s1.mp3"
            currentAudio.src = audioSrc; // Global HTML5 Audio elementinin kaynağını ayarla
            
            const onAudioEnded = () => {
                if (state.isMatchOver || state.isAnswered || !audioButton.classList.contains('playing-sound')) return;
                audioButton.classList.add('waiting');
                playIcon.style.display = 'block';
                stopIcon.style.display = 'none';
                state.audioInterval = setTimeout(() => {
                    audioButton.classList.remove('waiting');
                    if (audioButton.classList.contains('playing-sound') && !state.isAnswered && !state.isMatchOver) {
                        playIcon.style.display = 'none';
                        stopIcon.style.display = 'block';
                        currentAudio.play(); // Sesi tekrar oynat
                    }
                }, 5000);
            };
            currentAudio.onended = onAudioEnded;
            currentAudio.play().catch(e => console.warn(`HTML5 Audio oynatılamadı: ${audioSrc}`, e));
        }

        // >>> DEĞİŞİKLİK: stopAudioLoop (HTML5 Audio kullanır) <<<
        function stopAudioLoop() {
            clearTimeout(state.audioInterval);
            
            // HTML5 Audio elementini durdur
            if (!currentAudio.paused) {
                currentAudio.pause();
            }
            currentAudio.currentTime = 0;
            currentAudio.onended = null; // 'onended' callback'ini manuel durdurmada engelle

            if (audioButton.classList.contains('round-active') && !state.isAnswered) {
                clearTimeout(state.roundTimer);
                if (state.roundTimerStartTime) {
                    const elapsedTime = Date.now() - state.roundTimerStartTime;
                    state.roundTimerRemaining -= elapsedTime;
                }
                roundTimerBar.style.animationPlayState = 'paused';
            }
            audioButton.classList.remove('playing-sound', 'waiting');
            playIcon.style.display = 'block';
            stopIcon.style.display = 'none';
        }

        // --- CEVAPLAMA VE SONUÇ FONKSİYONLARI ---

        document.querySelectorAll('#image-grid-1 .image-container').forEach(container => {
            container.addEventListener('click', handleAnswer);
        });

        function handleAnswer(e) {
            const playerSection = e.currentTarget.closest('.player-section');
            if (playerSection.id !== 'player1-section') return;
            const player = 'player1';
            if (!audioButton.classList.contains('round-active') || state.answers[player] !== null || state.isMatchOver || state.isAnswered) return;
            
            playSound('click'); // Efekt sesi (Web Audio)
            
            const selectedContainer = e.currentTarget;
            const selectedId = parseInt(selectedContainer.dataset.id);
            state.answers[player] = selectedId;
            state.answerTimestamps[player] = Date.now();
            playerSection.querySelector('.image-grid').classList.add('locked');
            selectedContainer.classList.add('selected');
            state.isAnswered = true;
            clearTimeout(state.roundTimer);
            roundTimerBar.style.animationPlayState = 'paused';
            
            stopAudioLoop(); // Oyun sesi (HTML5 Audio)
            
            processAnswers();
        }

        function processAnswers() {
            if (!state.isMatchOver) { 
                nextRoundButton.disabled = false; 
                nextRoundButton.classList.add('pulse-active'); 
            }
            stopAudioLoop(); 
            clearTimeout(state.roundTimer);
            if (state.isMatchOver || !state.questions[state.currentRound - 1]) return;
            const currentDot = document.querySelectorAll('.progress-dot')[state.currentRound - 1];
            const correctId = state.questions[state.currentRound - 1].id;
            const p1Answer = state.answers.player1;
            const p1Correct = (p1Answer === correctId);
            const p1Choice = (p1Answer !== null) ? grid1.querySelector(`.image-container[data-id='${p1Answer}']`) : null;
            const allCorrectContainers = document.querySelectorAll(`#image-grid-1 .image-container[data-id='${correctId}']`);
            allCorrectContainers.forEach(c => { c.classList.remove('selected'); c.classList.add('correct'); });
            let anyCorrect = false;
            if (p1Correct) {
                anyCorrect = true;
                if (currentDot) currentDot.classList.add('correct'); 
            } else { 
                if (p1Answer !== null && !p1Correct) {
                    if (p1Choice) { p1Choice.classList.remove('selected'); p1Choice.classList.add('incorrect'); }
                }
                if (currentDot) currentDot.classList.add('incorrect'); 
            }
            
            if (anyCorrect) playSound('correct'); else playSound('incorrect'); // Efekt sesleri (Web Audio)
            
            grid1.classList.add('locked');
            setTimeout(() => {
                if (state.currentRound >= state.totalRounds && !state.isMatchOver) { endMatch(); } 
                else if (!state.isMatchOver) { nextRoundButton.disabled = false; }
            }, 1000);
        }

        function handleTimeout() {
            if (state.isAnswered || state.isMatchOver) return;
            state.isAnswered = true;
            roundTimerBar.style.animationPlayState = 'paused';
            stopAudioLoop(); 
            processAnswers();
        }

        function endMatch() {
            if (state.isMatchOver) return;
            state.isMatchOver = true;
            stopAudioLoop(); clearTimeout(state.roundTimer);
            overlay.classList.add('visible');
            overlay.classList.remove('transparent-bg');
            countdownDisplay.style.display = 'none';
            resetButton.style.display = 'block';
            audioButton.disabled = true;
            nextRoundButton.disabled = true;
            resetRound();
        }

        function resetForNewGame() {
            resetButton.style.display = 'none';
            playerSelectPrompt.style.display = 'flex';
            winnerDisplay.style.display = 'none';
            document.querySelectorAll('.progress-dot').forEach(dot => {
                dot.classList.remove('correct', 'incorrect');
            });
        }

        // --- OYUNU BAŞLATMA ---

        // Sadece "Başla" butonunu gösterir.
        function showStartButton() {
             if (audioContext.state === 'suspended') {
                 audioContext.resume().catch(() => {});
             }
            loadingIndicator.classList.add('hidden');
            overlay.classList.add('visible', 'transparent-bg');
            startButton.style.display = 'block';
        }

        // Event Listeners
        startButton.addEventListener('click', loadAllAssetsAndStart);
        startCountdownButton.addEventListener('click', startCountdownAndGame);
        resetButton.addEventListener('click', resetForNewGame);
        audioButton.addEventListener('click', toggleAudio);

        document.querySelectorAll('#image-grid-1 .image-container').forEach(container => {
            container.addEventListener('click', handleAnswer);
        });

        nextRoundButton.addEventListener('click', () => {
            if (state.isMatchOver) return;
            nextRoundButton.disabled = true;
            nextRound();
            if (!state.isMatchOver && state.currentRound <= state.totalRounds) toggleAudio();
        });

        showStartButton();
    </script>
</body>
</html>