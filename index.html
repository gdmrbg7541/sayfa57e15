<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§ÙØ³Ù’ØªÙÙ…ÙØ¹Ù’ Ø¥ÙÙ„Ù‰ Ø§Ù„ØµÙÙ‘ÙˆÙ’Øª</title>
    <style>
        /* CSS KISMINDAN HÄ°Ã‡BÄ°R DEÄÄ°ÅÄ°KLÄ°K YAPILMADI */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@700&family=Noto+Naskh+Arabic:wght@700&display=swap');

        :root {
            --player1-bg: #4a90e2;
            --player2-bg: #e24a4a;
            --correct-color: #50e3c2;
            --incorrect-color: #d0021b;
            --neutral-bg: #f4f4f4;
            --dark-text: #333;
            --selected-color: #888;
            --bonus-yellow: #ffde59;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        html { overflow: hidden; }
        body {
            font-family: 'Cairo', sans-serif;
            display: flex; justify-content: center; align-items: center;
            height: 100dvh; background-color: var(--neutral-bg); overflow: hidden; direction: ltr;
        }

        #loading-indicator {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex; justify-content: center; align-items: center;
            font-size: 2rem; color: var(--dark-text);
            z-index: 200; opacity: 1; transition: opacity 0.5s ease-out;
        }
        #loading-indicator.hidden { opacity: 0; pointer-events: none; }

        #game-container { display: flex; width: 100%; height: 100%; position: relative; }

        #progress-bar { 
            position: absolute; top: 0; left: 0; width: 100%; 
            display: flex; gap: 0; justify-content: center; align-items: center; 
            height: 30px; 
            z-index: 51;
        }
        .progress-dot { 
            flex: 1; 
            height: 100%; 
            background-color: #ccc; 
            border-radius: 0; 
            transition: background-color 0.3s;
            border-left: 1px solid #f4f4f4; 
        }
        .progress-dot:first-child { border-left: none; }

        .progress-dot.correct { background-color: var(--correct-color); }
        .progress-dot.incorrect { background-color: var(--incorrect-color); }
        
        #game-header {
            position: absolute; top: 30px; 
            left: 0; width: 100%; padding: 15px; background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; z-index: 50; direction: rtl;
            opacity: 0; transform: translateY(-30px); transition: opacity 0.6s ease, transform 0.6s ease;
        }
        #game-header.visible { opacity: 1; transform: translateY(0); }
        #game-header h1 { font-family: 'Noto Naskh Arabic', serif; font-size: 2.8rem; margin: 0; color: var(--dark-text); }


        .player-section {
            flex: 1; 
            padding: 180px 5px 120px 5px; 
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; 
            transition: background-color 0.3s; height: 100%; overflow-y: auto; position: relative;
        }
        #player1-section { background-color: rgba(74, 144, 226, 0.1); }
        
        #player2-section { 
            display: none; 
            background-color: rgba(226, 74, 74, 0.1); 
        }

        .hud { 
            position: absolute;
            right: 20px;
            z-index: 55; 
            text-align: right; 
            margin-top: 0; 
            margin-bottom: 0;
            opacity: 0; 
            top: 75px; 
            transform: translateY(-50%) scale(0.8); 
            transition: opacity 0.6s ease, transform 0.6s ease; 
        }
        .hud.visible { opacity: 1; transform: translateY(-50%) scale(1); }

        #player2-section .player-icon svg { fill: var(--player2-bg); }

        .player-score {
            display: inline-block;
            min-width: 96px;
            padding: 6px 16px;
            border: 3px solid rgba(0,0,0,0.08);
            background: #fff;
            border-radius: 12px;
            font-size: 3.0rem;
            font-weight: bold;
            color: var(--dark-text);
            line-height: 1.1;
        }

        #center-controls {
            position: absolute; 
            bottom: 20px; 
            right: 20px; 
            left: auto; 
            transform: none; 
            display: flex; 
            flex-direction: row; 
            align-items: center; 
            gap: 10px; 
            z-index: 10;
            opacity: 0; transition: opacity 0.6s ease, transform 0.6s ease;
        }
        #center-controls.visible { opacity: 1; transform: none; }

        #round-timer-bar-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 12px; background-color: #ccc; z-index: 51; display: none; }
        #round-timer-bar { width: 100%; height: 100%; background-color: var(--incorrect-color); transform: scaleX(1); transform-origin: left; }

        @keyframes deplete-linear { 0% { transform: scaleX(1); } 100% { transform: scaleX(0); } }

        #audio-button {
            position: relative; width: 80px; height: 80px; border-radius: 50%; background-color: white; cursor: pointer;
            display: flex; justify-content: center; align-items: center; transition: all 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 5px solid #ccc; z-index: 12;
        }
        #audio-button .icon { width: 35px; height: 35px; fill: #333; z-index: 13; }
        #audio-button .icon.stop-icon { display: none; }
        #audio-button.waiting .play-icon { animation: pulse-wait 1.5s infinite ease-in-out; }
        @keyframes pulse-wait { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        #audio-button:disabled { cursor: not-allowed; opacity: 0.5; }

        #audio-button::before,
        #audio-button::after {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            border-radius: 50%;
            background-color: transparent;
            border: 4px solid var(--player1-bg);
            opacity: 0;
            transform: scale(1);
            z-index: 11; 
        }
        #audio-button.playing-sound::before {
            animation: wave-pulse 1.5s ease-out infinite;
        }
        #audio-button.playing-sound::after {
            animation: wave-pulse 1.5s ease-out 0.5s infinite;
        }
        @keyframes wave-pulse {
            0% { transform: scale(1); opacity: 0.6; }
            100% { transform: scale(1.4); opacity: 0; }
        }


        #next-round-button {
            margin-top: 0; 
            width: 80px;
            height: 80px;
            border-radius: 50%;
            padding: 0;
            font-size: 2.5rem; 
            font-weight: bold; cursor: pointer; border: none; 
            background-color: var(--correct-color); color: var(--dark-text); box-shadow: 0 5px 15px rgba(0,0,0,0.15); transition: transform 0.2s; z-index: 11; 
            display: none; 
            justify-content: center;
            align-items: center;
            line-height: 1; 
        }
        #next-round-button:hover { transform: scale(1.05); }

        .image-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; 
            max-width: 840px; 
            margin: 0 auto;
            border: 5px solid transparent; border-radius: 20px; padding: 5px; transition: all 0.6s ease;
        }
        .image-grid.highlight { border-color: var(--player1-bg); box-shadow: 0 0 20px var(--player1-bg); }
        .image-grid.locked .image-container { pointer-events: none; opacity: 0.7; }

        .image-container {
            width: 100%; padding-top: 100%; position: relative; border: 5px solid transparent; border-radius: 15px; overflow: hidden;
            background-color: #e0e0e0; transition: transform 0.2s, border-color 0.2s, opacity 0.2s; cursor: pointer;
        }
        .image-grid.locked .image-container.selected { border-color: var(--selected-color); opacity: 1; transform: scale(0.95); }
        .image-container img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .image-container.correct { border-color: var(--correct-color); opacity: 1; }
        .image-container.incorrect { border-color: var(--incorrect-color); opacity: 1; }

        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; direction: rtl;
            opacity: 0; pointer-events: none; transition: opacity 0.8s ease, background-color 0.8s ease;
        }
        #overlay.visible { opacity: 1; pointer-events: auto; }
        #overlay.transparent-bg { background-color: transparent; }

        .overlay-button {
            padding: 20px 40px; font-family: 'Noto Naskh Arabic', serif; font-size: 2.5rem; cursor: pointer; border: none; border-radius: 10px;
            background-color: var(--player1-bg); color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #reset-icon { font-size: 5rem; cursor: pointer; display: none; }
        #countdown { font-size: 12rem; font-weight: bold; color: var(--dark-text); animation: zoom-fade 1s ease-in-out infinite; }

        #winner-display {
            font-family: 'Noto Naskh Arabic', serif; 
            font-size: 3.0rem; font-weight: bold; color: var(--dark-text);
            margin-bottom: 20px; display: none; text-align: center; animation: zoom-fade 1.5s ease-in-out infinite;
        }

        #player-select-prompt { display: none; flex-direction: column; align-items: center; text-align: center; }
        #player-select-text { font-family: 'Noto Naskh Arabic', serif; font-size: 3.5rem; font-weight: bold; color: var(--dark-text); margin-bottom: 20px; }
        #start-countdown-button { font-size: 6rem; cursor: pointer; background: none; border: none; padding: 10px; color: var(--dark-text); transition: transform 0.2s ease-out; animation: zoom-fade 1.5s ease-in-out infinite; }
        #start-countdown-button:hover { transform: scale(1.1); }

        @keyframes zoom-fade { 0% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1); opacity: 1; } 100% { transform: scale(0.8); opacity: 0.5; } }

        .score-burst {
            position: absolute; z-index: 205; pointer-events: none;
            font-size: 2.2rem; font-weight: 800; color: #1b3350; background: #ffffff;
            border: 2px solid rgba(0,0,0,0.08); border-radius: 14px; padding: 8px 14px;
            box-shadow: 0 10px 24px rgba(0,0,0,0.12); opacity: 1;
        }

        .speed-bonus-burst {
            position: absolute; z-index: 210; pointer-events: none;
            display: inline-flex; align-items: center; gap: 10px;
            font-size: 2.2rem; font-weight: 900; color: #000; background: var(--bonus-yellow);
            border: 2px solid rgba(0,0,0,0.08); border-radius: 16px; padding: 10px 16px;
            box-shadow: 0 12px 28px rgba(0,0,0,0.14); opacity: 1;
        }
        .speed-bonus-burst .lightning {
            font-size: 2.8rem; line-height: 1;
            filter: drop-shadow(0 0 6px rgba(255,215,0,0.85));
            text-shadow: 0 0 2px #000, 0 0 8px rgba(255,215,0,0.85), 0 0 14px rgba(255,215,0,0.65);
        }

        .celebration-animation { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10rem; z-index: 90; opacity: 0; pointer-events: none; }
        .celebration-animation.show { animation: fade-burst-out 3s ease-out forwards; }
        @keyframes fade-burst-out {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0.2); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(2); }
        }

        @media (max-width: 768px) {
            #progress-bar { height: 20px; }
            #game-header { top: 20px; }

            #center-controls { bottom: 20px; right: 20px; }
            #audio-button { width: 70px; height: 70px; }
            #next-round-button { width: 70px; height: 70px; }
            
            .player-section { padding: 150px 5px 110px 5px; } 
            
            .hud { 
                top: 55px; 
                right: 15px; 
            } 
            .image-grid { gap: 5px; max-width: 100%; }
            .player-score { font-size: 1.8rem; }
            #game-header h1 { font-size: 2.0rem; } 

            .progress-dot { border-radius: 0; }
            #winner-display { font-size: 2.2rem; }
            #player-select-text { font-size: 2.5rem; }
            #start-countdown-button { font-size: 5rem; }
        }
        @media (max-width: 480px) {
            #progress-bar { height: 15px; }
            #game-header { top: 15px; }

            .player-section { padding: 140px 5px 100px 5px; } 
            
            .hud { 
                top: 48px; 
                right: 10px; 
            } 

            #center-controls { bottom: 10px; right: 10px; gap: 5px;}
            #audio-button { width: 60px; height: 60px; }
            #audio-button .icon { width: 30px; height: 30px; }
            #next-round-button { width: 60px; height: 60px; font-size: 2rem; }

            #game-header h1 { font-size: 1.8rem; } 
            .progress-dot { border-radius: 0; }
        }
    </style>
</head>
<body>
    <div id="loading-indicator">...ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>

    <div id="game-container">
        
        <div id="progress-bar">
            <div class="progress-dot"></div>
            <div class="progress-dot"></div>
            <div class="progress-dot"></div>
            <div class="progress-dot"></div>
            <div class="progress-dot"></div>
            <div class="progress-dot"></div>
            <div class="progress-dot"></div>
            <div class="progress-dot"></div>
        </div>

        <div id="game-header">
            <h1>Ø§ÙØ³Ù’ØªÙÙ…ÙØ¹Ù’ Ø¥ÙÙ„Ù‰ Ø§Ù„ØµÙÙ‘ÙˆÙ’ØªØŒ ÙˆÙØ§Ø®Ù’ØªÙØ± Ø§Ù„ØµÙ‘ÙˆØ±ÙØ© Ø§Ù„Ù…ÙÙ†Ø§Ø³ÙØ¨ÙØ©</h1>
        </div>

        <div class="hud">
            <div class="player-score" id="score1">0</div>
        </div>

        <div class="player-section" id="player1-section">
            <div class="image-grid" id="image-grid-1">
                <div class="image-container"></div>
                <div class="image-container"></div>
                <div class="image-container"></div>
                <div class="image-container"></div>
            </div>
            <div class="celebration-animation" id="celebration-p1">ğŸ‰</div>
        </div>

        <div class="player-section" id="player2-section">
            <div class="hud">
                 <div class="player-icon">
                     <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                 </div>
                <div class="player-score" id="score2">0</div>
            </div>
            <div class="image-grid" id="image-grid-2">
                <div class="image-container"></div>
                <div class="image-container"></div>
                <div class="image-container"></div>
                <div class="image-container"></div>
            </div>
            <div class="celebration-animation" id="celebration-p2">ğŸ‰</div>
        </div>

        <div id="center-controls">
            <button id="audio-button" disabled>
                <svg class="icon play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                <svg class="icon stop-icon" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"></path></svg>
            </button>
            <button id="next-round-button">Â»</button>
        </div>

        <div id="round-timer-bar-container">
            <div id="round-timer-bar"></div>
        </div>

        <div id="overlay">
            <div id="countdown" style="display: none;"></div>
            <div id="winner-display"></div>

            <div id="player-select-prompt">
                <div id="player-select-text">Ù‡ÙÙ„Ù’ Ø£ÙÙ†Ù’Øª Ù…ÙØ³Ù’ØªÙØ¹ÙØ¯Ù‘ØŸ</div>
                <button id="start-countdown-button">â–¶ï¸</button>
            </div>
            <button class="overlay-button" id="start-button">Ø§ÙØ¨Ù’Ø¯ÙØ£Ù’</button>
            <div id="reset-icon">&#128260;</div>
        </div>
    </div>

    <script>
        const loadingIndicator = document.getElementById('loading-indicator');
        const startButton = document.getElementById('start-button');
        const overlay = document.getElementById('overlay');
        const countdownDisplay = document.getElementById('countdown');
        const resetButton = document.getElementById('reset-icon');
        const audioButton = document.getElementById('audio-button');
        const playIcon = audioButton.querySelector('.play-icon');
        const stopIcon = audioButton.querySelector('.stop-icon');

        const nextRoundButton = document.getElementById('next-round-button');

        const roundTimerBarContainer = document.getElementById('round-timer-bar-container');
        const roundTimerBar = document.getElementById('round-timer-bar');

        const gameHeader = document.getElementById('game-header');
        const centerControls = document.getElementById('center-controls');
        const allHuds = document.querySelectorAll('.hud');
        const allGrids = document.querySelectorAll('#image-grid-1'); 
        const grid1 = document.getElementById('image-grid-1');

        const allImageContainers = document.querySelectorAll('.image-container');

        const score1Display = document.getElementById('score1');
        const gameContainer = document.getElementById('game-container');

        const celebrationP1 = document.getElementById('celebration-p1');

        const winnerDisplay = document.getElementById('winner-display');

        const playerSelectPrompt = document.getElementById('player-select-prompt');
        const startCountdownButton = document.getElementById('start-countdown-button');

        // >>> DEÄÄ°ÅÄ°KLÄ°K: HÄ°BRÄ°T MODEL BAÅLANGICI <<<
        
        // 1. Web Audio API (DoÄŸru, YanlÄ±ÅŸ, TÄ±klama, YÃ¶nerge sesleri iÃ§in)
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const audioBuffers = {};

        // 2. new Audio() (GÃ¶rsel sesleri s1, s2... iÃ§in)
        let currentAudio = new Audio(); 

        // 3. Web Audio API ile yÃ¼klenecek seslerin listesi
        const soundUrls = {
            correct: 'https://www.myinstants.com/media/sounds/correct.mp3',
            incorrect: 'https://www.myinstants.com/media/sounds/error_CDOxCYm.mp3',
            click: 'https://www.myinstants.com/media/sounds/mouse-click-sound-effect-hd.mp3',
            instruction: 'yonerge_3.mp3' // Live Server gerektirir!
        };
        
        // >>> HÄ°BRÄ°T MODEL SONU <<<

        const gameData = [
            { id: 1, image: "1.png", audio: "s1.wav" },
            { id: 2, image: "2.png", audio: "s2.wav" },
            { id: 3, image: "3.png", audio: "s3.wav" },
            { id: 4, image: "4.png", audio: "s4.wav" },
            { id: 5, image: "5.png", audio: "s5.wav" },
            { id: 6, image: "6.png", audio: "s6.wav" },
            { id: 7, image: "7.png", audio: "s7.wav" },
            { id: 8, image: "8.png", audio: "s8.wav" }
        ];

        let state = {
            scores: { player1: 0 },
            currentRound: 0,
            totalRounds: 8, 
            questions: [],
            isAnswered: false,
            answers: { player1: null },
            answerTimestamps: { player1: null },
            roundTimer: null,
            audioInterval: null,
            isMatchOver: false,
            roundTimerStartTime: null,
            roundTimerRemaining: 0
        };

        function preloadImages() {
            return new Promise((resolve) => {
                let loadedCount = 0;
                const totalImages = gameData.length;
                if (totalImages === 0) { resolve(); return; }
                gameData.forEach(item => {
                    const img = new Image();
                    img.src = item.image;
                    img.onload = img.onerror = () => { loadedCount++; if (loadedCount === totalImages) resolve(); };
                });
            });
        }

        // >>> DEÄÄ°ÅÄ°KLÄ°K: Web Audio API iÃ§in ses YÃœKLEYÄ°CÄ° <<<
        async function loadAudio(key, url) {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            try {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                audioBuffers[key] = audioBuffer;
            } catch (error) {
                console.error(`Web Audio API sesi yÃ¼klenemedi ${key} (${url}):`, error);
            }
        }

        // >>> DEÄÄ°ÅÄ°KLÄ°K: Web Audio API iÃ§in ses OYNATICI <<<
        function playSound(key, onEndedCallback = null) {
            if (!audioBuffers[key]) {
                console.warn(`Ses buffer'Ä± bulunamadÄ±: ${key}`);
                if (onEndedCallback) onEndedCallback();
                return null;
            }
            if (audioContext.state !== 'running') {
                console.warn(`AudioContext Ã§alÄ±ÅŸmÄ±yor. KullanÄ±cÄ± etkileÅŸimi bekleniyor.`);
                // KullanÄ±cÄ± tÄ±kladÄ±ÄŸÄ±nda context'i 'resume' etmek iÃ§in playInstructionAndStart'a gÃ¼veniyoruz
                if (onEndedCallback) onEndedCallback();
                return null;
            }
            
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffers[key];
            source.connect(audioContext.destination);
            
            if (onEndedCallback) {
                source.onended = onEndedCallback;
            }
            source.start(0);
            return source;
        }

        // >>> DEÄÄ°ÅÄ°KLÄ°K: HÄ°BRÄ°T preloadAudio fonksiyonu <<<
        function preloadAudio() {
            const promises = [];

            // 1. Web Audio API seslerini (UI sesleri) yÃ¼kle
            for (const [key, url] of Object.entries(soundUrls)) {
                promises.push(loadAudio(key, url));
            }

            // 2. 'new Audio' seslerini (gÃ¶rsel sesleri) tarayÄ±cÄ± Ã¶nbelleÄŸine yÃ¼kle
            const gameAudioPromise = new Promise((resolve) => {
                let loadedCount = 0;
                const totalAudio = gameData.length;
                if (totalAudio === 0) return resolve();
                
                const onAudioLoad = () => { 
                    loadedCount++; 
                    if (loadedCount === totalAudio) resolve(); 
                };

                gameData.forEach(item => {
                    const audio = new Audio();
                    audio.src = item.audio;
                    audio.addEventListener('canplaythrough', onAudioLoad, { once: true });
                    audio.addEventListener('error', onAudioLoad, { once: true }); // Hata olsa da yÃ¼klemeyi bitir
                });
            });
            promises.push(gameAudioPromise);

            return Promise.all(promises);
        }


        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startGame() {
            playerSelectPrompt.style.display = 'none';
            startMatch();
            toggleAudio();
        }

        // >>> DEÄÄ°ÅÄ°KLÄ°K: YÃ¶nerge sesini Web Audio API ile Ã§al <<<
        function playInstructionAndStart() {
            // TÄ±klama ile AudioContext'i baÅŸlat (gerekliyse)
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            startButton.style.display = 'none';

            // YÃ¶nerge bittiÄŸinde
            const onInstructionEnd = () => {
                countdownDisplay.style.display = 'none';
                playerSelectPrompt.style.display = 'flex';
                overlay.classList.remove('transparent-bg');
            };

            // YÃ¶nerge sesini Ã§al, bittiÄŸinde onInstructionEnd'i tetikle
            playSound('instruction', onInstructionEnd);
        }

        // >>> DEÄÄ°ÅÄ°KLÄ°K: AudioContext'i baÅŸlat (gerekliyse) <<<
        function startCountdownAndGame() {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            playerSelectPrompt.style.display = 'none';
            overlay.classList.remove('visible'); overlay.classList.remove('transparent-bg');
            startGame();
        }

        function startMatch() {
            state.scores = { player1: 0 };
            state.currentRound = 0;
            state.isMatchOver = false;
            updateScores();

            state.questions = shuffleArray([...gameData]).slice(0, state.totalRounds)
                .map(item => ({ ...item, duration: 30000 }));

            nextRound();
        }

        function nextRound() {
            if (state.isMatchOver || state.currentRound >= state.totalRounds) {
                if (!overlay.classList.contains('visible') && !state.isMatchOver) endMatch();
                return;
            }
            resetRound();

            const currentQuestion = state.questions[state.currentRound];
            const correctId = currentQuestion.id;

            // ... (Distractor logic)
            // >>> DEÄÄ°ÅÄ°KLÄ°K: Yeni Ã§eldirici kuralÄ± (1. gÃ¶rsel; 2,3,4 ile gelmesin) <<<
            const conflictGroupA = [1];
            const conflictGroupB = [2, 3, 4];

            let bannedDistractorIds = []; // Ã‡eldirici olarak KULLANILAMAYACAK ID'ler

            if (conflictGroupA.includes(correctId)) {
                // EÄŸer doÄŸru cevap '1' ise, '2, 3, 4' Ã§eldirici olamaz.
                bannedDistractorIds = conflictGroupB;
            } else if (conflictGroupB.includes(correctId)) {
                // EÄŸer doÄŸru cevap '2', '3' veya '4' ise, '1' Ã§eldirici olamaz.
                bannedDistractorIds = conflictGroupA;
            }

            // 'possibleDistractors' listesini oluÅŸtur
            const possibleDistractors = gameData.filter(item => {
                // 1. Kendisi olamaz (doÄŸru cevap)
                if (item.id === correctId) return false;
                
                // 2. Yeni kurala gÃ¶re yasaklÄ± listeyse olamaz
                if (bannedDistractorIds.includes(item.id)) return false;
                
                // DiÄŸerleri olabilir
                return true;
            });

            // KalanlarÄ± karÄ±ÅŸtÄ±r
            const shuffledDistractors = shuffleArray(possibleDistractors);
            
            // Ä°lk 3 tanesini Ã§eldirici olarak al
            const finalDistractors = shuffledDistractors.slice(0, 3);
            // ... (Distractor logic sonu)

            const options = shuffleArray([currentQuestion, ...finalDistractors]);
            const optionsP1 = [...options];

            document.querySelectorAll('#image-grid-1 .image-container').forEach((c, i) => {
                c.dataset.id = optionsP1[i].id;
                const img = document.createElement('img');
                img.src = optionsP1[i].image; img.alt = "Ø®ÙŠØ§Ø±";
                c.appendChild(img);
            });
            
            audioButton.disabled = false;
            state.currentRound++;
        }

        function resetRound() {
            state.isAnswered = false;
            state.answers = { player1: null };
            state.answerTimestamps = { player1: null };
            state.roundTimerStartTime = null;
            state.roundTimerRemaining = 0;

            clearTimeout(state.roundTimer);
            stopAudioLoop(); // Bu artÄ±k 'new Audio()'yu durduracak

            audioButton.classList.remove('round-active');

            roundTimerBarContainer.style.display = 'none';
            roundTimerBar.classList.remove('active');
            roundTimerBar.style.animation = 'none';
            roundTimerBar.style.animationPlayState = 'running';
            void roundTimerBar.offsetWidth;
            roundTimerBar.style.animation = null;

            grid1.classList.remove('locked');

            celebrationP1.classList.remove('show');

            allImageContainers.forEach(container => {
                container.classList.remove('correct', 'incorrect', 'locked', 'selected');
                const img = container.querySelector('img');
                if (img) img.remove();
            });
        }

        function toggleAudio() {
            if (state.isMatchOver || state.isAnswered || state.currentRound > state.totalRounds || !state.questions[state.currentRound - 1]) return;

            if (!audioButton.classList.contains('round-active')) {
                audioButton.classList.add('round-active', 'playing-sound', 'waiting');

                const currentDuration = state.questions[state.currentRound - 1].duration;
                state.roundTimerStartTime = Date.now();
                state.roundTimerRemaining = currentDuration;

                roundTimerBarContainer.style.display = 'block';
                roundTimerBar.style.animation = `deplete-linear ${currentDuration / 1000}s linear forwards`;
                roundTimerBar.classList.add('active');

                state.roundTimer = setTimeout(handleTimeout, state.roundTimerRemaining);

                setTimeout(() => {
                    if (state.isMatchOver || !audioButton.classList.contains('round-active') || state.isAnswered) return;
                    audioButton.classList.remove('waiting');
                    startAudioLoop(true); // 'new Audio' dÃ¶ngÃ¼sÃ¼nÃ¼ baÅŸlat
                }, 2000);
            } else {
                if (audioButton.classList.contains('playing-sound')) {
                    stopAudioLoop(); // 'new Audio' dÃ¶ngÃ¼sÃ¼nÃ¼ durdur
                } else {
                    startAudioLoop(false); // 'new Audio' dÃ¶ngÃ¼sÃ¼nÃ¼ baÅŸlat
                }
            }
        }

        // >>> DEÄÄ°ÅÄ°KLÄ°K: GÃ–RSEL SESLERÄ° (s1, s2...) Ä°Ã‡Ä°N ESKÄ° 'new Audio()' MANTIÄINA DÃ–NÃœLDÃœ <<<
        function startAudioLoop(isInitialCall) {
            if (state.isMatchOver || state.isAnswered || !audioButton.classList.contains('round-active') || state.currentRound > state.totalRounds || !state.questions[state.currentRound - 1]) return;

            if (!isInitialCall) {
                state.roundTimerStartTime = Date.now();
                state.roundTimer = setTimeout(handleTimeout, state.roundTimerRemaining);
                roundTimerBar.style.animationPlayState = 'running';
            }

            audioButton.classList.add('playing-sound');
            playIcon.style.display = 'none';
            stopIcon.style.display = 'block';

            const audioSrc = state.questions[state.currentRound - 1].audio;
            currentAudio.src = audioSrc;

            currentAudio.onended = () => {
                if (state.isMatchOver || state.isAnswered || !audioButton.classList.contains('playing-sound')) return;
                audioButton.classList.add('waiting');
                playIcon.style.display = 'block';
                stopIcon.style.display = 'none';
                state.audioInterval = setTimeout(() => {
                    audioButton.classList.remove('waiting');
                    if (audioButton.classList.contains('playing-sound') && !state.isAnswered && !state.isMatchOver) {
                        playIcon.style.display = 'none';
                        stopIcon.style.display = 'block';
                        currentAudio.play();
                    }
                }, 5000);
            };

            currentAudio.play().catch(() => {});
        }

        // >>> DEÄÄ°ÅÄ°KLÄ°K: GÃ–RSEL SESLERÄ° (s1, s2...) Ä°Ã‡Ä°N ESKÄ° 'new Audio()' MANTIÄINA DÃ–NÃœLDÃœ <<<
        function stopAudioLoop() {
            clearTimeout(state.audioInterval);
            
            // Ã‡alan 'new Audio' sesini durdur
            if (!currentAudio.paused) {
                currentAudio.pause();
            }
            currentAudio.currentTime = 0;
            currentAudio.onended = null;

            if (audioButton.classList.contains('round-active') && !state.isAnswered) {
                clearTimeout(state.roundTimer);
                if (state.roundTimerStartTime) {
                    const elapsedTime = Date.now() - state.roundTimerStartTime;
                    state.roundTimerRemaining -= elapsedTime;
                }
                roundTimerBar.style.animationPlayState = 'paused';
            }

            audioButton.classList.remove('playing-sound', 'waiting');
            playIcon.style.display = 'block';
            stopIcon.style.display = 'none';
        }

        document.querySelectorAll('.image-container').forEach(container => {
            container.addEventListener('click', handleAnswer);
        });

        // >>> DEÄÄ°ÅÄ°KLÄ°K: TÄ±klama sesi Web Audio API ile Ã§alÄ±nÄ±yor <<<
        function handleAnswer(e) {
            const playerSection = e.currentTarget.closest('.player-section');
            
            if (playerSection.id !== 'player1-section') return;
            
            const player = 'player1';

            if (!audioButton.classList.contains('round-active') ||
                state.answers[player] !== null ||
                state.isMatchOver ||
                state.isAnswered) return;

            playSound('click'); // Web Audio API tÄ±klama sesi

            const selectedContainer = e.currentTarget;
            const selectedId = parseInt(selectedContainer.dataset.id);

            state.answers[player] = selectedId;
            state.answerTimestamps[player] = Date.now();

            playerSection.querySelector('.image-grid').classList.add('locked');
            selectedContainer.classList.add('selected');

            state.isAnswered = true;
            clearTimeout(state.roundTimer);
            roundTimerBar.style.animationPlayState = 'paused';
            stopAudioLoop(); // 'new Audio' sesini durdur
            processAnswers();
        }

        // >>> DEÄÄ°ÅÄ°KLÄ°K: DoÄŸru/YanlÄ±ÅŸ sesleri Web Audio API ile Ã§alÄ±nÄ±yor <<<
        function processAnswers() {
            stopAudioLoop(); // 'new Audio' sesini durdur
            clearTimeout(state.roundTimer);
            if (state.isMatchOver || !state.questions[state.currentRound - 1]) return;

            const currentDot = document.querySelectorAll('.progress-dot')[state.currentRound - 1];

            const correctId = state.questions[state.currentRound - 1].id;
            const p1Answer = state.answers.player1;
            const p1Correct = (p1Answer === correctId);

            const p1Choice = (p1Answer !== null) ? grid1.querySelector(`.image-container[data-id='${p1Answer}']`) : null;
            const allCorrectContainers = document.querySelectorAll(`.image-container[data-id='${correctId}']`);

            allCorrectContainers.forEach(c => { c.classList.remove('selected'); c.classList.add('correct'); });

            let anyCorrect = false;

            if (p1Correct) {
                // Puan 12.5
                state.scores.player1 += 12.5;
                if (p1Choice) animateScoreBox(p1Choice, 'player1', 12.5);
                anyCorrect = true;
                if (currentDot) currentDot.classList.add('correct'); 
            } else { 
                if (p1Answer !== null && !p1Correct) {
                    if (p1Choice) { p1Choice.classList.remove('selected'); p1Choice.classList.add('incorrect'); }
                }
                if (currentDot) currentDot.classList.add('incorrect'); 
            }

            updateScores();

            // Web Audio API ile Ã§al
            if (anyCorrect) playSound('correct'); else playSound('incorrect');

            grid1.classList.add('locked');

            setTimeout(() => {
                if (state.currentRound >= state.totalRounds && !state.isMatchOver) {
                    endMatch();
                } else if (!state.isMatchOver) {
                    nextRoundButton.style.display = 'flex';
                }
            }, 3200);
        }

        function handleTimeout() {
            if (state.isAnswered || state.isMatchOver) return;
            state.isAnswered = true;
            roundTimerBar.style.animationPlayState = 'paused';
            stopAudioLoop(); // 'new Audio' sesini durdur
            processAnswers();
        }

        function animateScoreBox(sourceElement, player, points) {
            if (!sourceElement) return;
            const burst = document.createElement('div');
            burst.className = 'score-burst';
            burst.textContent = `+${points}`;
            gameContainer.appendChild(burst);

            const startRect = sourceElement.getBoundingClientRect();
            burst.style.left = `${startRect.left + startRect.width / 2}px`;
            burst.style.top  = `${startRect.top + startRect.height / 2}px`;

            burst.animate([
                { transform: 'translate(-50%, -50%) scale(0.98)', opacity: 1 },
                { transform: 'translate(-50%, calc(-50% - 180px)) scale(0.95)', opacity: 0 }
            ], { duration: 3000, easing: 'cubic-bezier(.2,.8,.2,1)' });

            setTimeout(() => burst.remove(), 3000);
        }

        function animateSpeedBonusBox(sourceElement, player, points) {
            if (!sourceElement) return;
            const bonus = document.createElement('div');
            bonus.className = 'speed-bonus-burst';
            bonus.innerHTML = `<span class="lightning">âš¡</span><span>+${points}</span>`;
            gameContainer.appendChild(bonus);

            const startRect = sourceElement.getBoundingClientRect();
            bonus.style.left = `${startRect.left + startRect.width / 2}px`;
            bonus.style.top  = `${startRect.top + startRect.height / 2}px`;

            bonus.animate([
                { transform: 'translate(-50%, -50%) scale(0.98)', opacity: 1 },
                { transform: 'translate(-50%, calc(-50% - 200px)) scale(0.92)', opacity: 0.05 }
            ], { duration: 2600, easing: 'cubic-bezier(.2,.8,.2,1)' });

            setTimeout(() => bonus.remove(), 2600);
        }

        function updateScores() {
            score1Display.textContent = state.scores.player1;
        }

        function endMatch() {
            if (state.isMatchOver) return;
            state.isMatchOver = true;
            stopAudioLoop(); clearTimeout(state.roundTimer);

            winnerDisplay.textContent = `Ù†ÙØªÙŠØ¬ÙØªÙÙƒ: ${state.scores.player1}`; // "PuanÄ±n: X"
            winnerDisplay.style.color = 'var(--dark-text)';
            celebrationP1.classList.add('show');
            
            winnerDisplay.style.display = 'block';

            overlay.classList.add('visible');
            overlay.classList.remove('transparent-bg');
            countdownDisplay.style.display = 'none';
            resetButton.style.display = 'block';

            audioButton.disabled = true;
            resetRound();
        }

        function resetForNewGame() {
            resetButton.style.display = 'none';
            playerSelectPrompt.style.display = 'flex';
            winnerDisplay.style.display = 'none';
            
            document.querySelectorAll('.progress-dot').forEach(dot => {
                dot.classList.remove('correct', 'incorrect');
            });

            celebrationP1.classList.remove('show');
        }

        async function runIntroAnimation() {
            // Hibrit yÃ¼kleyiciyi Ã§alÄ±ÅŸtÄ±r
            await Promise.all([preloadImages(), preloadAudio()]);
            
            loadingIndicator.classList.add('hidden');
            overlay.classList.add('visible', 'transparent-bg');

            setTimeout(() => { gameHeader.classList.add('visible'); }, 600);
            setTimeout(() => { allHuds.forEach(hud => hud.classList.add('visible')); }, 1200);
            
            setTimeout(() => { allGrids.forEach(grid => grid.classList.add('highlight')); }, 1800);
            setTimeout(() => { centerControls.classList.add('visible'); }, 2400);
            setTimeout(() => { allGrids.forEach(grid => grid.classList.remove('highlight')); }, 3000);
        }

        startButton.addEventListener('click', playInstructionAndStart);
        startCountdownButton.addEventListener('click', startCountdownAndGame);
        resetButton.addEventListener('click', resetForNewGame);
        audioButton.addEventListener('click', toggleAudio);

        document.querySelectorAll('#image-grid-1 .image-container').forEach(container => {
            container.addEventListener('click', handleAnswer);
        });

        nextRoundButton.addEventListener('click', () => {
            if (state.isMatchOver) return;
            nextRoundButton.style.display = 'none';
            nextRound();
            if (!state.isMatchOver && state.currentRound <= state.totalRounds) toggleAudio();
        });

        runIntroAnimation();
    </script>
</body>
</html>